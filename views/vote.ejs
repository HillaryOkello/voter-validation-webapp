<%- include('partials/header', {title: 'Vote - Election Voting System'}) %>

<div class="header">
    <h1>Cast Your Vote</h1>
    <p class="lead">Please enter your membership number and complete the ballot</p>
</div>

<div class="form-container">
    <div id="validationSection">
        <h3>Step 1: Validate Your Membership</h3>
        <form id="validationForm">
            <div class="mb-3">
                <label for="membershipNumber" class="form-label">Membership Number</label>
                <input type="text" class="form-control" id="membershipNumber" required>
                <div class="form-text">Enter your membership number exactly as it appears on your membership card.</div>
            </div>
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phoneNumber" required pattern="[0-9]+" title="Please enter a valid phone number (numbers only)">
                <div class="form-text">Enter your phone number as registered with MMC for verification.</div>
            </div>
            <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="fullName" required>
                <div class="form-text">Enter your full name as it appears on the membership record.</div>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email Address (Optional)</label>
                <input type="email" class="form-control" id="email">
                <div class="form-text">Your email will be used to send you a confirmation of your vote.</div>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Validate Membership</button>
            </div>
            <div id="validationAlert" class="alert alert-danger mt-3 hidden"></div>
            <!-- Removed link to membership lookup for security reasons -->
        </form>
    </div>

    <div id="votingSection" class="hidden">
        <h3>Step 2: Complete Your Ballot - MMC Election 2025</h3>
        <form id="votingForm">
            <!-- Deputy People's Warden (3 candidates) -->
            <div class="mb-4 candidate-section">
                <h5>Select your preferred candidate for Deputy People's Warden</h5>

                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/sammy_matano.jpeg" class="card-img-top candidate-image" alt="Sammy Andrew Matano" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deputyPeoplesWarden" id="deputy1" value="Sammy Andrew Matano" required>
                                    <label class="form-check-label fw-bold" for="deputy1">Sammy Andrew Matano</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/catherine_mkala.jpeg" class="card-img-top candidate-image" alt="Catherine G. M Mkala" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deputyPeoplesWarden" id="deputy3" value="Catherine G. M Mkala">
                                    <label class="form-check-label fw-bold" for="deputy3">Catherine G. M Mkala</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chairman Finance & General Purpose Committee (2 candidates) -->
            <div class="mb-4 candidate-section">
                <h5>Chairman Finance & General Purpose Committee</h5>

                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/willis_okwacho.jpeg" class="card-img-top candidate-image" alt="Willis Odhiambo Okwacho" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chairmanFinance" id="finance1" value="Willis Odhiambo Okwacho" required>
                                    <label class="form-check-label fw-bold" for="finance1">Willis Odhiambo Okwacho</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/dalton_mwaghogho.jpeg" class="card-img-top candidate-image" alt="FCPA Dalton Mwaghogho" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chairmanFinance" id="finance2" value="FCPA Dalton Mwaghogho">
                                    <label class="form-check-label fw-bold" for="finance2">FCPA Dalton Mwaghogho</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success">Submit Ballot</button>
            </div>
            <div id="votingAlert" class="alert mt-3 hidden"></div>
        </form>
    </div>

    <div id="confirmationSection" class="hidden text-center">
        <div class="alert alert-success">
            <h4>Thank You!</h4>
            <p>Your vote has been recorded successfully.</p>
            <p>A confirmation has been sent to your email address.</p>
        </div>
        <a href="/" class="btn btn-primary">Return to Home</a>
    </div>
</div>

<style>
    .candidate-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    .candidate-image-container {
        height: 250px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
    }

    .candidate-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center 15%; /* Focus more on face than lower body */
        transition: transform 0.3s ease;
    }

    .card:hover .candidate-image {
        transform: scale(1.05); /* Subtle zoom effect on hover */
    }

    .placeholder-image {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e9ecef;
        color: #6c757d;
        font-size: 14px;
        text-align: center;
    }

    .placeholder-image svg {
        width: 50px;
        height: 50px;
        opacity: 0.7;
    }

    .card {
        height: 100%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s;
        border: 1px solid rgba(0,0,0,.125);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .card-body {
        padding: 1rem;
        background-color: #fff;
    }

    .form-check {
        padding-left: 0;
    }

    .form-check-input {
        margin-right: 10px;
    }

    .fw-bold {
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const validationForm = document.getElementById('validationForm');
        const votingForm = document.getElementById('votingForm');
        const validationSection = document.getElementById('validationSection');
        const votingSection = document.getElementById('votingSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const validationAlert = document.getElementById('validationAlert');
        const votingAlert = document.getElementById('votingAlert');

        let membershipNumber = '';
        let phoneNumber = '';
        let fullName = '';
        let email = '';

        // Check if membership number was passed in URL (from lookup)
        const urlParams = new URLSearchParams(window.location.search);
        const urlMembershipNumber = urlParams.get('membershipNumber');

        if (urlMembershipNumber) {
            document.getElementById('membershipNumber').value = urlMembershipNumber;
        }

        validationForm.addEventListener('submit', function(e) {
            e.preventDefault();

            membershipNumber = document.getElementById('membershipNumber').value;
            phoneNumber = document.getElementById('phoneNumber').value;
            fullName = document.getElementById('fullName').value;
            email = document.getElementById('email').value;

            validationAlert.classList.add('hidden');

            // Validate membership number
            fetch('/api/validate-membership', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber, phoneNumber, fullName, email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Show voting section
                    validationSection.classList.add('hidden');
                    votingSection.classList.remove('hidden');
                } else {
                    // Show error message
                    validationAlert.textContent = data.message;
                    validationAlert.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                validationAlert.textContent = 'An error occurred. Please try again.';
                validationAlert.classList.remove('hidden');
            });
        });

        votingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(votingForm);
            const votes = {
                deputyPeoplesWarden: formData.get('deputyPeoplesWarden'),
                delegateToSynod: formData.get('delegateToSynod'),
                secretary: formData.get('secretary'),
                sidemen: Array.from(formData.getAll('sidemen')),
                viceChairman: formData.get('viceChairman'),
                peoplesWarden: formData.get('peoplesWarden'),
                chairmanFinance: formData.get('chairmanFinance'),
                treasurer: formData.get('treasurer')
            };

            votingAlert.classList.add('hidden');

            // Submit vote
            fetch('/api/submit-vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber, phoneNumber, fullName, email, votes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show confirmation
                    votingSection.classList.add('hidden');
                    confirmationSection.classList.remove('hidden');
                } else {
                    // Show error message
                    votingAlert.textContent = data.message;
                    votingAlert.classList.remove('hidden');
                    votingAlert.classList.add('alert-danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                votingAlert.textContent = 'An error occurred while submitting your vote. Please try again.';
                votingAlert.classList.remove('hidden');
                votingAlert.classList.add('alert-danger');
            });
        });
    });
</script>

<%- include('partials/footer') %>
