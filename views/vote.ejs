<%- include('partials/header', {title: 'Vote - Election Voting System'}) %>

<div class="header">
    <h1>Cast Your Vote</h1>
    <p class="lead">Please enter your membership number and complete the ballot</p>
</div>

<div class="form-container">
    <div id="validationSection">
        <h3>Step 1: Validate Your Membership</h3>
        <form id="validationForm">
            <div class="mb-3">
                <label for="membershipNumber" class="form-label">Membership Number</label>
                <input type="text" class="form-control" id="membershipNumber" required>
                <div class="form-text">Enter your membership number exactly as it appears on your membership card.</div>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required pattern="[^@\s]+@[^@\s]+\.[^@\s]+" title="Please enter a valid email address">
                <div class="form-text">Your email will be used for confirmation purposes only. Each email can only be used once.</div>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Validate Membership</button>
            </div>
            <div id="validationAlert" class="alert alert-danger mt-3 hidden"></div>
            <!-- Removed link to membership lookup for security reasons -->
        </form>
    </div>

    <div id="votingSection" class="hidden">
        <h3>Step 2: Complete Your Ballot - MMC Election 2025</h3>
        <form id="votingForm">
            <!-- Deputy People's Warden (3 candidates) -->
            <div class="mb-4 candidate-section">
                <h5>Select your preferred candidate for Deputy People's Warden</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/sammy_matano.jpg" class="card-img-top candidate-image" alt="Sammy Andrew Matano" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deputyPeoplesWarden" id="deputy1" value="Sammy Andrew Matano" required>
                                    <label class="form-check-label fw-bold" for="deputy1">Sammy Andrew Matano</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/pascal_ouma.jpg" class="card-img-top candidate-image" alt="Pascal Onyango Ouma" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deputyPeoplesWarden" id="deputy2" value="Pascal Onyango Ouma">
                                    <label class="form-check-label fw-bold" for="deputy2">Pascal Onyango Ouma</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/catherine_mkala.jpg" class="card-img-top candidate-image" alt="Catherine G. M Mkala" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deputyPeoplesWarden" id="deputy3" value="Catherine G. M Mkala">
                                    <label class="form-check-label fw-bold" for="deputy3">Catherine G. M Mkala</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delegate to the Synod (1 candidate) -->
            <div class="mb-4 candidate-section">
                <h5>Delegate to the Synod</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/joyce_wakilo.jpg" class="card-img-top candidate-image" alt="Joyce Wakilo" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="delegateToSynod" id="delegate1" value="Joyce Wakilo" required>
                                    <label class="form-check-label fw-bold" for="delegate1">Joyce Wakilo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="delegateToSynod" id="delegateNone" value="None">
                                    <label class="form-check-label fw-bold" for="delegateNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secretary (1 candidate) -->
            <div class="mb-4 candidate-section">
                <h5>Secretary</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/rose_mwaumba.jpg" class="card-img-top candidate-image" alt="Rose Rebeccah Mlale Mwaumba" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="secretary" id="secretary1" value="Rose Rebeccah Mlale Mwaumba" required>
                                    <label class="form-check-label fw-bold" for="secretary1">Rose Rebeccah Mlale Mwaumba</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="secretary" id="secretaryNone" value="None">
                                    <label class="form-check-label fw-bold" for="secretaryNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidemen (3 candidates) -->
            <div class="mb-4 candidate-section">
                <h5>Sidemen (Select up to 3)</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/rhoda_oliech.jpg" class="card-img-top candidate-image" alt="Rhoda Oliech" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sidemen" id="sidemen1" value="Rhoda Oliech">
                                    <label class="form-check-label fw-bold" for="sidemen1">Rhoda Oliech</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/joseph_charo.jpg" class="card-img-top candidate-image" alt="Joseph Hare Charo" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sidemen" id="sidemen2" value="Joseph Hare Charo">
                                    <label class="form-check-label fw-bold" for="sidemen2">Joseph Hare Charo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/babelynn_mukila.jpg" class="card-img-top candidate-image" alt="Babelynn Mukila" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sidemen" id="sidemen3" value="Babelynn Mukila">
                                    <label class="form-check-label fw-bold" for="sidemen3">Babelynn Mukila</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vice Chairman (1 candidate) -->
            <div class="mb-4 candidate-section">
                <h5>Vice Chairman</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/gordon_yossa.jpg" class="card-img-top candidate-image" alt="Dr. Gordon Peter Yossa" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="viceChairman" id="viceChairman1" value="Dr. Gordon Peter Yossa" required>
                                    <label class="form-check-label fw-bold" for="viceChairman1">Dr. Gordon Peter Yossa</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="viceChairman" id="viceChairmanNone" value="None">
                                    <label class="form-check-label fw-bold" for="viceChairmanNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- People's Warden (1 candidate) -->
            <div class="mb-4 candidate-section">
                <h5>People's Warden</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/benjamin_karanja.jpg" class="card-img-top candidate-image" alt="Benjamin Allan Mbui Karanja" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="peoplesWarden" id="warden1" value="Benjamin Allan Mbui Karanja" required>
                                    <label class="form-check-label fw-bold" for="warden1">Benjamin Allan Mbui Karanja</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="peoplesWarden" id="wardenNone" value="None">
                                    <label class="form-check-label fw-bold" for="wardenNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chairman Finance & General Purpose Committee (2 candidates) -->
            <div class="mb-4 candidate-section">
                <h5>Chairman Finance & General Purpose Committee</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/willis_okwacho.jpg" class="card-img-top candidate-image" alt="Willis Odhiambo Okwacho" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chairmanFinance" id="finance1" value="Willis Odhiambo Okwacho" required>
                                    <label class="form-check-label fw-bold" for="finance1">Willis Odhiambo Okwacho</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/dalton_mwaghogho.jpg" class="card-img-top candidate-image" alt="FCPA Dalton Mwaghogho" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chairmanFinance" id="finance2" value="FCPA Dalton Mwaghogho">
                                    <label class="form-check-label fw-bold" for="finance2">FCPA Dalton Mwaghogho</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="chairmanFinance" id="financeNone" value="None">
                                    <label class="form-check-label fw-bold" for="financeNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Treasurer (1 candidate) -->
            <div class="mb-4 candidate-section">
                <h5>Treasurer</h5>
                
                <div class="row candidate-row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="candidate-image-container">
                                <img src="/images/candidates/peter_karoki.jpg" class="card-img-top candidate-image" alt="Peter Karoki" onerror="this.src='/images/placeholder.svg'">
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="treasurer" id="treasurer1" value="Peter Karoki" required>
                                    <label class="form-check-label fw-bold" for="treasurer1">Peter Karoki</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="treasurer" id="treasurerNone" value="None">
                                    <label class="form-check-label fw-bold" for="treasurerNone">None</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success">Submit Ballot</button>
            </div>
            <div id="votingAlert" class="alert mt-3 hidden"></div>
        </form>
    </div>

    <div id="confirmationSection" class="hidden text-center">
        <div class="alert alert-success">
            <h4>Thank You!</h4>
            <p>Your vote has been recorded successfully.</p>
            <p>A confirmation has been sent to your email address.</p>
        </div>
        <a href="/" class="btn btn-primary">Return to Home</a>
    </div>
</div>

<style>
    .candidate-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .candidate-image-container {
        height: 200px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    
    .candidate-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .placeholder-image {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e9ecef;
        color: #6c757d;
        font-size: 14px;
        text-align: center;
    }
    
    .placeholder-image svg {
        width: 50px;
        height: 50px;
        opacity: 0.7;
    }
    
    .card {
        height: 100%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .form-check {
        padding-left: 0;
    }
    
    .form-check-input {
        margin-right: 10px;
    }
    
    .fw-bold {
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const validationForm = document.getElementById('validationForm');
        const votingForm = document.getElementById('votingForm');
        const validationSection = document.getElementById('validationSection');
        const votingSection = document.getElementById('votingSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const validationAlert = document.getElementById('validationAlert');
        const votingAlert = document.getElementById('votingAlert');
        
        let membershipNumber = '';
        let email = '';
        
        // Check if membership number was passed in URL (from lookup)
        const urlParams = new URLSearchParams(window.location.search);
        const urlMembershipNumber = urlParams.get('membershipNumber');
        
        if (urlMembershipNumber) {
            document.getElementById('membershipNumber').value = urlMembershipNumber;
        }
        
        validationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            membershipNumber = document.getElementById('membershipNumber').value;
            email = document.getElementById('email').value;
            
            validationAlert.classList.add('hidden');
            
            // Validate membership number
            fetch('/api/validate-membership', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber, email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Show voting section
                    validationSection.classList.add('hidden');
                    votingSection.classList.remove('hidden');
                } else {
                    // Show error message
                    validationAlert.textContent = data.message;
                    validationAlert.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                validationAlert.textContent = 'An error occurred. Please try again.';
                validationAlert.classList.remove('hidden');
            });
        });
        
        votingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(votingForm);
            const votes = {
                deputyPeoplesWarden: formData.get('deputyPeoplesWarden'),
                delegateToSynod: formData.get('delegateToSynod'),
                secretary: formData.get('secretary'),
                sidemen: Array.from(formData.getAll('sidemen')),
                viceChairman: formData.get('viceChairman'),
                peoplesWarden: formData.get('peoplesWarden'),
                chairmanFinance: formData.get('chairmanFinance'),
                treasurer: formData.get('treasurer')
            };
            
            votingAlert.classList.add('hidden');
            
            // Submit vote
            fetch('/api/submit-vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber, email, votes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show confirmation
                    votingSection.classList.add('hidden');
                    confirmationSection.classList.remove('hidden');
                } else {
                    // Show error message
                    votingAlert.textContent = data.message;
                    votingAlert.classList.remove('hidden');
                    votingAlert.classList.add('alert-danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                votingAlert.textContent = 'An error occurred while submitting your vote. Please try again.';
                votingAlert.classList.remove('hidden');
                votingAlert.classList.add('alert-danger');
            });
        });
    });
</script>

<%- include('partials/footer') %>
