<%- include('partials/header', {title: 'Vote - Election Voting System'}) %>

<div class="header">
    <h1>Cast Your Vote</h1>
    <p class="lead">Please enter your membership number and complete the ballot</p>
</div>

<div class="form-container">
    <div id="validationSection">
        <h3>Step 1: Validate Your Membership</h3>
        <form id="validationForm">
            <div class="mb-3">
                <label for="membershipNumber" class="form-label">Membership Number</label>
                <input type="text" class="form-control" id="membershipNumber" required>
                <div class="form-text">Enter your membership number exactly as it appears on your membership card.</div>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
                <div class="form-text">Your email will be used for confirmation purposes only.</div>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Validate Membership</button>
            </div>
            <div id="validationAlert" class="alert alert-danger mt-3 hidden"></div>
            <div class="mt-3 text-center">
                <a href="/forgot-membership" class="btn btn-link">Forgot your membership number?</a>
            </div>
        </form>
    </div>

    <div id="votingSection" class="hidden">
        <h3>Step 2: Complete Your Ballot</h3>
        <form id="votingForm">
            <div class="mb-4">
                <h5>Select your preferred candidate for President</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="president" id="president1" value="Candidate 1" required>
                    <label class="form-check-label" for="president1">Candidate 1</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="president" id="president2" value="Candidate 2">
                    <label class="form-check-label" for="president2">Candidate 2</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="president" id="president3" value="Candidate 3">
                    <label class="form-check-label" for="president3">Candidate 3</label>
                </div>
            </div>

            <div class="mb-4">
                <h5>Select your preferred candidate for Vice President</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="vicePresident" id="vp1" value="VP Candidate 1" required>
                    <label class="form-check-label" for="vp1">VP Candidate 1</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="vicePresident" id="vp2" value="VP Candidate 2">
                    <label class="form-check-label" for="vp2">VP Candidate 2</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="vicePresident" id="vp3" value="VP Candidate 3">
                    <label class="form-check-label" for="vp3">VP Candidate 3</label>
                </div>
            </div>

            <div class="mb-4">
                <h5>Vote on the Budget Proposal</h5>
                <select class="form-select" name="budgetProposal" required>
                    <option value="" selected disabled>-- Select your vote --</option>
                    <option value="Approve">Approve</option>
                    <option value="Reject">Reject</option>
                    <option value="Abstain">Abstain</option>
                </select>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success">Submit Ballot</button>
            </div>
            <div id="votingAlert" class="alert mt-3 hidden"></div>
        </form>
    </div>

    <div id="confirmationSection" class="hidden text-center">
        <div class="alert alert-success">
            <h4>Thank You!</h4>
            <p>Your vote has been recorded successfully.</p>
            <p>A confirmation has been sent to your email address.</p>
        </div>
        <a href="/" class="btn btn-primary">Return to Home</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const validationForm = document.getElementById('validationForm');
        const votingForm = document.getElementById('votingForm');
        const validationSection = document.getElementById('validationSection');
        const votingSection = document.getElementById('votingSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const validationAlert = document.getElementById('validationAlert');
        const votingAlert = document.getElementById('votingAlert');
        
        let membershipNumber = '';
        let email = '';
        
        // Check if membership number was passed in URL (from lookup)
        const urlParams = new URLSearchParams(window.location.search);
        const urlMembershipNumber = urlParams.get('membershipNumber');
        
        if (urlMembershipNumber) {
            document.getElementById('membershipNumber').value = urlMembershipNumber;
        }
        
        validationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            membershipNumber = document.getElementById('membershipNumber').value;
            email = document.getElementById('email').value;
            
            validationAlert.classList.add('hidden');
            
            // Validate membership number
            fetch('/api/validate-membership', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Show voting section
                    validationSection.classList.add('hidden');
                    votingSection.classList.remove('hidden');
                } else {
                    // Show error message
                    validationAlert.textContent = data.message;
                    validationAlert.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                validationAlert.textContent = 'An error occurred. Please try again.';
                validationAlert.classList.remove('hidden');
            });
        });
        
        votingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(votingForm);
            const votes = {
                president: formData.get('president'),
                vicePresident: formData.get('vicePresident'),
                budgetProposal: formData.get('budgetProposal')
            };
            
            votingAlert.classList.add('hidden');
            
            // Submit vote
            fetch('/api/submit-vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ membershipNumber, email, votes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show confirmation
                    votingSection.classList.add('hidden');
                    confirmationSection.classList.remove('hidden');
                } else {
                    // Show error message
                    votingAlert.textContent = data.message;
                    votingAlert.classList.remove('hidden');
                    votingAlert.classList.add('alert-danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                votingAlert.textContent = 'An error occurred while submitting your vote. Please try again.';
                votingAlert.classList.remove('hidden');
                votingAlert.classList.add('alert-danger');
            });
        });
    });
</script>

<%- include('partials/footer') %>
